# Система аутентификации и авторизации с RBAC

Реализация сервиса аутентификации и авторизации с кастомной системой прав доступа (RBAC).

Приложение предоставляет REST API для управления пользователями, ролями и динамического распределения прав доступа к бизнес-элементам системы.

## Стек технологий

* **Язык:** Python 3.11
* **Фреймворк:** FastAPI
* **База данных:** PostgreSQL (драйвер `asyncpg`)
* **ORM:** SQLAlchemy (Async)
* **Миграции:** Alembic
* **Контейнеризация:** Docker, Docker Compose

## Функциональность

### 1. Аутентификация и Пользователи
* Регистрация, вход в систему (выдача JWT токенов).
* Валидация паролей с использованием `bcrypt`.
* Управление профилем пользователя (обновление данных).
* **Soft Delete**: При удалении пользователя запись остается в БД, но помечается флагом `is_active=False`. Доступ к API для такого пользователя блокируется мгновенно.

### 2. Динамический RBAC (Система прав)
Реализована гибкая матрица доступа, хранящаяся в базе данных. В отличие от статических проверок ролей (admin/user), система позволяет настраивать права доступа для каждой роли к конкретному ресурсу.

**Основные сущности:**
* **User**: Привязан к одной Роли.
* **Role**: Группирует пользователей (например: *admin, manager, user*).
* **BusinessElement**: Ресурс системы, к которому ограничивается доступ (например: *users, reports, finance*).
* **AccessRule**: Правило, связывающее Роль и Бизнес-элемент. Содержит булевы флаги разрешений:
    * `read_permission` / `read_all_permissions`
    * `create_permission`
    * `update_permission` / `update_all_permissions`
    * `delete_permission` / `delete_all_permissions`

**Особенности реализации:**
* **Динамическое создание ресурсов:** Администратор может создать новый бизнес-элемент через API. Система автоматически сгенерирует правила доступа для всех существующих ролей (Admin получает полные права, остальные — запрет по умолчанию).
* **Проверка прав:** Осуществляется через Dependency Injection (`PermissionChecker`), который делает запрос в БД и проверяет наличие конкретного флага для текущей роли пользователя и запрашиваемого ресурса.

## Установка и запуск

Проект полностью контейнеризирован. Для запуска требуется Docker и Docker Compose.

1.  **Клонирование репозитория:**
    ```bash
    git clone https://github.com/Esmien/EffectiveMobile_test
    cd EffectiveMobile_test
    ```

2.  **Настройка окружения:**
    Переименуйте файл `.env.example` в `.env`:
    ```bash
    cp .env.example .env
    ```
    *При необходимости скорректируйте переменные окружения внутри файла.*

3.  **Запуск контейнеров:**
    ```bash
    docker compose up --build -d
    ```

При запуске автоматически:
* Поднимется база данных PostgreSQL.
* Применятся миграции Alembic.
* Выполнится скрипт инициализации (`init_db`), который создаст базовые роли, администратора, тестовый бизнес-элемент `users` с полными правами для администратора и начальные права.

## Документация API

После запуска документация Swagger UI доступна по адресу:
http://localhost:8000/docs

### Тестовые данные (создаются автоматически)

**Администратор:**
* Email: `admin@admin.com`
* Password: `admin`

**Роли по умолчанию:**
* `admin` (полные права)
* `manager` (частичные права к пользователям)
* `user` (права только на чтение своего профиля)

## Структура проекта

* `app/api` — Эндпоинты (Auth, Users, Admin, Business Elements).
* `app/core` — Конфигурация, безопасность (JWT, Hashing).
* `app/database` — Подключение к БД, инициализация.
* `app/models` — SQLAlchemy модели (User, RBAC).
* `app/schemas` — Pydantic схемы для валидации данных.
* `alembic` — Файлы миграций.